# AcrocanthoMD CANFD インターフェース仕様書

**バージョン**: v1.0  
**対象**: STM32G474RET6マイコン搭載ブラシレスDCモーター制御システム  
**通信方式**: FDCAN（CAN FD）32バイトペイロード  
**制御周期**: 約10kHz（100μs）

## 目次

1. [CANID構造](#canid構造)
2. [制御モード](#制御モード)
3. [受信データ構造](#受信データ構造)
4. [送信データ構造](#送信データ構造)
5. [機能制御フラグ](#機能制御フラグ)
6. [通信設定](#通信設定)
7. [データ形式](#データ形式)
8. [安全機能](#安全機能)
9. [性能仕様](#性能仕様)
10. [開発者情報](#開発者情報)

---

## CANID構造

### 基本構造（11bit標準ID）
```
Bit:  10  9  8  7  6 | 5  4  3  2  1  0
      [  Command   ] | [  Device ID   ]
      (5bit: 0-31)   | (6bit: 0-63)
```

### CANID計算式
```c
// 送信ID生成
uint32_t txID = (0x14 << 6) | canDevID;
// 例: デバイスID=1の場合 → 0x501

// 受信時コマンド抽出
uint8_t command = (rxID >> 6) & 0x1F;
uint8_t deviceID = rxID & 0x3F;
```

### デフォルト設定
- **デバイスID**: 1 (`canDevID = 1`)
- **送信ID**: 0x501
- **受信フィルタ**: 0x500-0x53F（デバイスID=1用）

---

## 制御モード

### 制御モード定義
| モード | 値 | 名称 | 説明 | 階層レベル |
|--------|-------|------|------|-----------|
| `CTRLMODE_NONE` | 0 | 制御なし | サーボOFF、安全停止 | - |
| `CTRLMODE_VOLT` | 1 | 電圧制御 | 直接dq軸電圧指令 | L1 |
| `CTRLMODE_CUR` | 2 | 電流制御 | dq軸電流指令（PI制御） | L2 |
| `CTRLMODE_VEL` | 3 | 速度制御 | 角速度指令（PID制御） | L3 |
| `CTRLMODE_POS` | 4 | 位置制御 | 角度指令（PID制御） | L4 |

### 階層制御構造
```
位置制御(L4) → 速度制御(L3) → 電流制御(L2) → 電圧制御(L1) → PWM出力
```

---

## 受信データ構造

### データフォーマット（32バイト固定）

#### 共通ヘッダ（全モード共通）
| バイト | 型 | 内容 | 説明 |
|--------|--------|------|------|
| 0-3 | uint32_t | genFuncRef | 機能制御フラグ |

#### 制御モード別データ配置

**CTRLMODE_VOLT（電圧制御）**
| バイト | 型 | 内容 | 単位 | 範囲 |
|--------|--------|------|------|------|
| 0-3 | uint32_t | genFuncRef | - | - |
| 4-7 | float | virAngFreq | Hz | 0-1000 |
| 8-11 | float | voltDRef | V | ±24.0 |
| 12-15 | float | voltQRef | V | ±24.0 |
| 16-31 | - | 未使用 | - | - |

**CTRLMODE_CUR（電流制御）**
| バイト | 型 | 内容 | 単位 | 範囲 |
|--------|--------|------|------|------|
| 0-3 | uint32_t | genFuncRef | - | - |
| 4-7 | float | curDRef | A | ±10.0 |
| 8-11 | float | curQRef | A | ±10.0 |
| 12-31 | - | 未使用 | - | - |

**CTRLMODE_VEL（速度制御）**
| バイト | 型 | 内容 | 単位 | 範囲 |
|--------|--------|------|------|------|
| 0-3 | uint32_t | genFuncRef | - | - |
| 4-7 | float | velRef | rad/s | GIM6010: ±9.0<br>GIM8108: ±5.0 |
| 8-31 | - | 未使用 | - | - |

**CTRLMODE_POS（位置制御）**
| バイト | 型 | 内容 | 単位 | 範囲 |
|--------|--------|------|------|------|
| 0-3 | uint32_t | genFuncRef | - | - |
| 4-7 | float | posRef | rad | ±∞ |
| 8-31 | - | 未使用 | - | - |

---

## 送信データ構造

### フィードバックデータ（32バイト固定）
| バイト | 型 | 内容 | 単位 | 説明 |
|--------|--------|------|------|------|
| 0-3 | float | voltDRef | V | dq軸電圧指令値 |
| 4-7 | float | voltQRef | V | dq軸電圧指令値 |
| 8-11 | float | curD | A | d軸電流実測値 |
| 12-15 | float | curQ | A | q軸電流実測値 |
| 16-19 | float | velAct | rad/s | 角速度実測値 |
| 20-23 | float | posAct | rad | 角度実測値 |
| 24-27 | uint32_t | status | - | システム状態 |
| 28 | uint8_t | eCalib | - | キャリブレーション状態 |
| 29-31 | - | 予約 | - | 将来拡張用 |

### ステータスフィールド詳細
| Bit | 内容 | 説明 |
|-----|------|------|
| 0 | servoState | サーボ状態（0:OFF, 1:ON） |
| 1-7 | 予約 | 将来拡張用 |
| 8-15 | controlMode | 現在の制御モード |
| 16-23 | errorCode | エラーコード |
| 24-31 | 予約 | 将来拡張用 |

---

## 機能制御フラグ

### genFuncRef ビット定義（uint32_t）
| Bit | マスク | 名称 | 機能 |
|-----|--------|------|------|
| 0 | 0x01 | サーボON/OFF | 0:OFF, 1:ON |
| 4 | 0x10 | 電気角キャリブ | 立ち上がりエッジで開始 |
| 5 | 0x20 | 6点回転制御 | 立ち上がりエッジで開始 |
| その他 | - | 予約 | 将来拡張用 |

### 使用例
```c
// サーボON
genFuncRef = 0x01;

// サーボON + 電気角キャリブレーション開始
genFuncRef = 0x11;

// サーボON + 6点回転制御開始
genFuncRef = 0x21;
```

### 制御フロー
1. **genFuncCheck**: 前回値と比較して変化を検出
2. **立ち上がりエッジ検出**: 特定ビットの0→1変化
3. **機能実行**: 対応する制御シーケンス開始

---

## 通信設定

### FDCAN設定
```c
// ボーレート: 1Mbps
// データ段階: 2Mbps（FD使用時）
// ペイロード: 32バイト固定
// IDタイプ: 標準11bit ID
```

### フィルタ設定
```c
// 受信フィルタ（デバイスID=1の場合）
FDCAN_FilterTypeDef filter = {
    .IdType = FDCAN_STANDARD_ID,
    .FilterIndex = 0,
    .FilterType = FDCAN_FILTER_RANGE,
    .FilterConfig = FDCAN_FILTER_TO_RXFIFO0,
    .FilterID1 = 0x500,    // 開始ID
    .FilterID2 = 0x53F     // 終了ID (0x14 << 6 | 0x3F)
};
```

---

## データ形式

### エンディアン形式
- **ビッグエンディアン形式**を使用
- ByteConverterクラスで自動変換

### データ変換例
```cpp
// float値の送信
ByteConverter::writeFloat(txData, offset, floatValue);

// float値の受信
float value = ByteConverter::readFloat(rxData, offset);

// uint32_t値の送信
ByteConverter::writeUint32(txData, offset, uint32Value);

// uint32_t値の受信
uint32_t value = ByteConverter::readUint32(rxData, offset);
```

### 精度仕様
- **float型**: IEEE 754単精度（32bit）
- **分解能**: 約7桁の有効数字
- **範囲**: ±1.18e-38 ~ ±3.40e+38

---

## 安全機能

### 電圧制限
```c
// モーター別電圧制限（param.h）
#ifdef GIM6010_8
#define VOLT_MAX  24.0f    // 最大電圧
#define VOLT_MIN -24.0f    // 最小電圧
#endif

#ifdef GIM8108_8  
#define VOLT_MAX  24.0f
#define VOLT_MIN -24.0f
#endif
```

### 電流制限
```c
// モーター別電流制限
GIM6010_8: ±10.0A
GIM8108_8: ±10.0A
```

### 速度制限
```c
// モーター別速度制限
GIM6010_8: ±9.0 rad/s
GIM8108_8: ±5.0 rad/s
```

### フェイルセーフ
- **通信タイムアウト**: 自動的にサーボOFF
- **過電流保護**: ハードウェア保護回路
- **過温度保護**: サーミスタ監視（実装依存）

---

## 性能仕様

### 制御性能
- **制御周期**: 10kHz（100μs）
- **分解能**: 12bit（4096カウント/回転）
- **位置精度**: ±0.09°（12bit分解能）
- **応答性**: PID調整により最適化

### 通信性能
- **レイテンシ**: <1ms（通信遅延）
- **スループット**: 320kbps（32バイト×10kHz）
- **エラー率**: <0.01%（CAN FDエラー検出）

### リアルタイム制約
- **ADC割り込み**: 100μs周期厳守
- **制御計算時間**: <50μs
- **通信処理時間**: <10μs

---

## 開発者情報

### カスタマイズ可能パラメータ

**デバイスID変更**
```c
// can_communication.h
constexpr uint32_t canDevID = 1;  // 1-63に変更可能
```

**制御ゲイン調整**
```c
// param.h - モーター別ゲイン設定
curKp, curKi, curKd    // 電流制御ゲイン
velKp, velKi, velKd    // 速度制御ゲイン  
posKp, posKi, posKd    // 位置制御ゲイン
```

**制御制限値変更**
```c
// param.h - モーター別制限値
volMin, volMax         // 電圧制限
curQMin, curQMax       // 電流制限
velMin, velMax         // 速度制限
```

### デバッグ機能
```c
// user_task.cpp
#define TEST_MODE      // テストモード有効化
```

### エラーコード
| コード | 説明 | 対処法 |
|--------|------|--------|
| 0x01 | 通信エラー | 配線・設定確認 |
| 0x02 | 過電流 | 負荷確認・ゲイン調整 |
| 0x04 | エンコーダエラー | センサ確認 |
| 0x08 | 過温度 | 冷却・負荷軽減 |

### 開発ツール
- **STM32CubeIDE**: 開発・デバッグ環境
- **CAN FDアナライザ**: 通信解析
- **オシロスコープ**: 信号確認

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| v1.0 | 2025-07-16 | 初版リリース |

---

## 注意事項

1. **電源電圧**: 24V±10%の範囲で使用
2. **配線長**: CAN配線は最大30m以内
3. **終端抵抗**: CAN配線の両端に120Ω終端抵抗必須
4. **EMC対策**: ツイストペア線・シールド線推奨
5. **安全運転**: 初回起動時は低ゲインで動作確認

本仕様書は、AcrocanthoMDとの安全で効率的な通信実装のためのリファレンスです。不明な点があれば、ソースコードも併せて参照してください。